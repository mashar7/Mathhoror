<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Math vs Pocong - Ultimate Breathing Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
    <style>
        body { margin: 0; background: #000; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        canvas { border: 4px solid #00ffcc; border-radius: 10px; box-shadow: 0 0 20px rgba(0, 255, 204, 0.3); }
    </style>
</head>
<body>
    <div id="game-container"></div>

    <script>
    class BootScene extends Phaser.Scene {
        constructor() { super('BootScene'); }
        preload() {
            let g = this.make.graphics({x: 0, y: 0, add: false});
            // Background Malam Gelap
            g.fillStyle(0x0f172a); g.fillRect(0, 0, 800, 600); g.generateTexture('bg', 800, 600);
            // Karakter & Musuh
            g.clear(); g.fillStyle(0xffffff); g.fillRect(0, 0, 50, 100); g.generateTexture('pocong', 50, 100);
            g.clear(); g.fillStyle(0x2ecc71); g.fillRect(0, 0, 60, 60); g.generateTexture('hero', 60, 60);
            // Layar Jumpscare
            g.clear(); g.fillStyle(0xff0000); g.fillRect(0, 0, 800, 600); g.generateTexture('ghost', 800, 600);
            
            // External Particle Flare
            this.load.image('flare', 'https://labs.phaser.io/assets/particles/white-flare.png');
            
            let txt = this.add.text(400, 300, 'MEMPERSIAPKAN RITUAL...', { align: 'center', fill: '#00ffcc', font: 'bold 24px Arial' }).setOrigin(0.5);
        }
        create() { this.scene.start('BattleScene'); }
    }

    class BattleScene extends Phaser.Scene {
        constructor() { 
            super('BattleScene'); 
            this.userInput = ""; this.ans = 0; this.wrong = 0; 
            this.combo = 0; this.maxCombo = 5;
            this.isLock = false; // KUNCI UTAMA: Mencegah stuck
        }
        
        create() {
            this.add.image(400, 300, 'bg');
            this.player = this.add.sprite(150, 450, 'hero');
            this.pocong = this.add.sprite(650, 450, 'pocong');
            this.jump = this.add.image(400, 300, 'ghost').setAlpha(0).setDepth(100);
            
            // Partikel ala Demon Slayer
            this.emitter = this.add.particles(0, 0, 'flare', {
                speed: { min: 150, max: 250 },
                scale: { start: 0.8, end: 0 },
                blendMode: 'ADD',
                lifespan: 600,
                emitting: false
            });

            // UI Elements
            this.uiSoal = this.add.text(400, 60, '', { font: 'bold 45px Courier', fill: '#00ffcc' }).setOrigin(0.5);
            this.uiInput = this.add.text(400, 135, '', { font: 'bold 55px Courier', fill: '#fff', backgroundColor: '#1e293b', padding: 15, fixedWidth: 250, align: 'center' }).setOrigin(0.5);
            
            this.add.text(400, 200, 'ENERGY PERNAPASAN', { font: 'bold 12px Arial', fill: '#fff' }).setOrigin(0.5);
            this.comboBar = this.add.graphics();
            
            this.createPad();
            this.newQuest();
        }

        updateComboBar() {
            this.comboBar.clear();
            this.comboBar.fillStyle(0x333333);
            this.comboBar.fillRect(300, 215, 200, 15);
            // Warna bar berubah jadi emas jika penuh
            let barColor = (this.combo >= this.maxCombo) ? 0xffff00 : 0x00ffcc;
            this.comboBar.fillStyle(barColor);
            this.comboBar.fillRect(300, 215, (this.combo / this.maxCombo) * 200, 15);
        }

        createPad() {
            const keys = ['1','2','3','4','5','6','7','8','9','DEL','0','ENT'];
            keys.forEach((k, i) => {
                let x = 300 + (i % 3) * 105;
                let y = 300 + Math.floor(i / 3) * 70;
                let b = this.add.text(x, y, k, { font: 'bold 24px Arial', backgroundColor: '#334155', padding: 15, fixedWidth: 90, align: 'center', color: '#fff' })
                    .setInteractive({ useHandCursor: true })
                    .on('pointerdown', () => {
                        if(this.isLock) return; // Abaikan jika sedang animasi
                        b.setBackgroundColor('#475569');
                        this.time.delayedCall(100, () => b.setBackgroundColor('#334155'));
                        this.handle(k);
                    });
            });
        }

        handle(k) {
            if(k === 'DEL') this.userInput = this.userInput.slice(0, -1);
            else if(k === 'ENT') this.check();
            else if(this.userInput.length < 5) this.userInput += k;
            this.uiInput.setText(this.userInput);
        }

        newQuest() {
            let a = Phaser.Math.Between(1, 20), b = Phaser.Math.Between(1, 20);
            this.ans = a + b;
            this.uiSoal.setText(`${a} + ${b} = ?`);
            this.userInput = ""; this.uiInput.setText("");
            this.updateComboBar();
            this.isLock = false; // Buka kunci setiap ada soal baru
        }

        check() {
            if(this.userInput === "" || this.isLock) return;

            if(parseInt(this.userInput) === this.ans) {
                this.isLock = true; // Kunci input
                this.combo++;
                
                if(this.combo >= this.maxCombo) {
                    this.ultimateAttack();
                } else {
                    this.normalAttack();
                }
            } else {
                this.handleError();
            }
        }

        normalAttack() {
            // Gerakan Dash Cepat
            this.tweens.add({
                targets: this.player, 
                x: 600, 
                duration: 150, 
                yoyo: true,
                onStart: () => { 
                    this.emitter.setTint(0x00ffcc); 
                    this.emitter.setPosition(this.player.x, this.player.y); 
                    this.emitter.start(); 
                },
                onComplete: () => { 
                    this.emitter.stop(); 
                    this.cameras.main.shake(150, 0.01); 
                    this.time.delayedCall(200, () => this.newQuest()); 
                }
            });
        }

        ultimateAttack() {
            this.combo = 0;
            // Efek Flash Layar Putih (Zantetsuken feel)
            this.cameras.main.flash(400, 255, 255, 255);
            
            this.tweens.add({
                targets: this.player, 
                x: 650, 
                scale: 2.5, 
                duration: 300, 
                yoyo: true,
                onStart: () => {
                    this.emitter.setTint(0xffff00); // Kuning Petir
                    this.emitter.start();
                    this.uiSoal.setText("PERNAPASAN MATEMATIKA!!!");
                },
                onComplete: () => {
                    this.emitter.stop();
                    this.cameras.main.shake(500, 0.04);
                    this.player.setScale(1);
                    this.time.delayedCall(300, () => this.newQuest());
                }
            });
        }

        handleError() {
            this.isLock = true; // Kunci saat salah
            this.wrong++;
            this.combo = 0; 
            this.updateComboBar();

            if(this.wrong >= 3) {
                // JUMPSCARE
                this.jump.setAlpha(1);
                this.cameras.main.shake(600, 0.05);
                this.time.delayedCall(800, () => { 
                    this.jump.setAlpha(0); 
                    this.wrong = 0; 
                    this.newQuest(); 
                });
            } else {
                // Flash Merah saat salah
                this.cameras.main.flash(200, 150, 0, 0);
                this.time.delayedCall(200, () => this.newQuest());
            }
        }
    }

    const config = {
        type: Phaser.AUTO,
        width: 800, height: 600,
        parent: 'game-container',
        scene: [BootScene, BattleScene]
    };
    new Phaser.Game(config);
    </script>
</body>
</html>
